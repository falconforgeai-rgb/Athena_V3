name: Verify Athena Integrity (v7)

on:
  workflow_dispatch:
    inputs:
      reason:
        description: 'Manual audit trigger reason'
        required: false
        default: 'Manual audit dispatch'
  push:
    branches: [ main ]

jobs:
  verify:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    env:
      LANG: "C.UTF-8"
      LC_ALL: "C.UTF-8"
      PYTHONUTF8: "1"

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          set -euo pipefail
          sudo apt-get update -qq
          sudo apt-get install -y jq curl
          python3 -m pip install --upgrade pip
          pip install jsonschema colorama requests

      - name: Ensure directories
        run: mkdir -p archive/CAP_LOGS schemas scripts config

      - name: Refresh canonical manifest and schema
        run: |
          set -euo pipefail
          echo "üîç Fetching canonical manifest and schema..."
          curl -sSL https://raw.githubusercontent.com/falconforgeai-rgb/falconforge-codex/main/falconforge-athena-v3_5/canonical/FalconForge_Integrity_Manifest_v3_5.json \
            -o schemas/FalconForge_Integrity_Manifest_v3_5.json
          curl -sSL https://raw.githubusercontent.com/falconforgeai-rgb/falconforge-codex/main/falconforge-athena-v3_5/canonical/ATHENA_CAP_SCHEMA_v3_5.json \
            -o schemas/ATHENA_CAP_SCHEMA_v3_5.json

          echo "‚úÖ Canonical files fetched successfully."
          head -n 2 schemas/FalconForge_Integrity_Manifest_v3_5.json || true

      - name: Validate JSON format
        run: |
          set -euo pipefail
          jq empty schemas/FalconForge_Integrity_Manifest_v3_5.json
          jq empty schemas/ATHENA_CAP_SCHEMA_v3_5.json
          echo "‚úÖ Both manifest and schema are valid JSON."

      - name: Verify schema integrity
        run: |
          set -euo pipefail
          EXPECTED_HASH=$(jq -r '.modules[] | select(.name=="ATHENA_CAP_SCHEMA_v3_5.json") | .sha256' schemas/FalconForge_Integrity_Manifest_v3_5.json | sed 's/SHA256://')
          if [ -z "$EXPECTED_HASH" ] || [ "$EXPECTED_HASH" = "null" ]; then
            echo "‚ùå Failed to extract canonical hash from manifest."
            exit 1
          fi
          ACTUAL_HASH=$(sha256sum schemas/ATHENA_CAP_SCHEMA_v3_5.json | awk '{print $1}')
          LOGFILE="archive/CAP_LOGS/integrity_$(date +'%Y%m%d_%H%M%S').log"

          echo "üßæ Manifest version: $(jq -r .version schemas/FalconForge_Integrity_Manifest_v3_5.json)" | tee -a "$LOGFILE"
          echo "üîë Expected hash: $EXPECTED_HASH" | tee -a "$LOGFILE"
          echo "üß© Actual hash:   $ACTUAL_HASH" | tee -a "$LOGFILE"
          echo "Workflow version: v7 | Run ID: $GITHUB_RUN_ID" | tee -a "$LOGFILE"

          if [ "$EXPECTED_HASH" != "$ACTUAL_HASH" ]; then
            echo "‚ùå Integrity mismatch detected!" | tee -a "$LOGFILE"
            exit 1
          fi
          echo "‚úÖ Integrity verified ‚Äî hashes match." | tee -a "$LOGFILE"

      - name: Run CAP validation
        run: |
          set -euo pipefail
          echo "üß† Running CAP validation via local_integrity_check.py"
          python3 scripts/local_integrity_check.py | tee -a archive/CAP_LOGS/integrity_latest.log

      - name: Prune old logs
        run: |
          set -euo pipefail
          echo "üßπ Retaining last 10 validation logs..."
          ls -t archive/CAP_LOGS/integrity_*.log | tail -n +11 | xargs -r rm --
          echo "ü™∂ Log rotation complete."

      - name: Final report
        if: success()
        run: echo "‚úÖ Athena Integrity (v7) ‚Äî All validations passed."

      - name: Failure report
        if: failure()
        run: echo "‚ùå Athena Integrity (v7) ‚Äî Validation failed. Check archive/CAP_LOGS/ for details."
