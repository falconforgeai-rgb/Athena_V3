name: Verify Athena Integrity (v7 Final)

on:
  workflow_dispatch:
    inputs:
      reason:
        description: "Manual audit trigger reason"
        required: false
        default: "Manual audit dispatch"
  push:
    branches: [ main ]

jobs:
  verify:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    env:
      LANG: "C.UTF-8"
      LC_ALL: "C.UTF-8"
      PYTHONUTF8: "1"

    steps:
      - name: ðŸ§© Checkout repository
        uses: actions/checkout@v4

      - name: ðŸ Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: ðŸ§° Install dependencies
        run: |
          set -euo pipefail
          sudo apt-get update -qq
          sudo apt-get install -y jq curl
          python3 -m pip install --upgrade pip
          pip install jsonschema colorama requests

      - name: ðŸ“ Ensure directory structure
        run: mkdir -p archive/CAP_LOGS schemas scripts config

      - name: ðŸ” Fetch canonical manifest + schema (atomic)
        run: |
          set -euo pipefail
          echo "ðŸ” Fetching canonical manifest and schema..."
          TMP_MANIFEST=$(mktemp)
          TMP_SCHEMA=$(mktemp)
          curl -fsSL https://raw.githubusercontent.com/falconforgeai-rgb/falconforge-codex/main/falconforge-athena-v3_5/canonical/FalconForge_Integrity_Manifest_v3_5.json -o "$TMP_MANIFEST"
          curl -fsSL https://raw.githubusercontent.com/falconforgeai-rgb/falconforge-codex/main/falconforge-athena-v3_5/canonical/ATHENA_CAP_SCHEMA_v3_5.json -o "$TMP_SCHEMA"
          mv "$TMP_MANIFEST" schemas/FalconForge_Integrity_Manifest_v3_5.json
          mv "$TMP_SCHEMA" schemas/ATHENA_CAP_SCHEMA_v3_5.json
          echo "âœ… Canonical files fetched safely (atomic write)."

      - name: ðŸ§¾ Validate JSON format
        run: |
          set -euo pipefail
          jq empty schemas/FalconForge_Integrity_Manifest_v3_5.json
          jq empty schemas/ATHENA_CAP_SCHEMA_v3_5.json
          echo "âœ… Both manifest and schema are valid JSON."

      - name: ðŸ”Ž Verify schema integrity
        run: |
          set -euo pipefail
          EXPECTED_HASH=$(jq -r '.modules[] | select(.name=="ATHENA_CAP_SCHEMA_v3_5.json") | .sha256' schemas/FalconForge_Integrity_Manifest_v3_5.json | sed 's/SHA256://')
          if [ -z "$EXPECTED_HASH" ] || [ "$EXPECTED_HASH" = "null" ]; then
            echo "âŒ Failed to extract canonical hash from manifest."
            exit 1
          fi
          ACTUAL_HASH=$(sha256sum schemas/ATHENA_CAP_SCHEMA_v3_5.json | awk '{print $1}')
          LOGFILE="archive/CAP_LOGS/integrity_$(date +'%Y%m%d_%H%M%S').log"

          {
            echo "ðŸ§¾ Manifest version: $(jq -r .version schemas/FalconForge_Integrity_Manifest_v3_5.json)"
            echo "ðŸ”‘ Expected hash: $EXPECTED_HASH"
            echo "ðŸ§© Actual hash:   $ACTUAL_HASH"
            echo "Workflow version: v7 Final | Run ID: $GITHUB_RUN_ID"
          } | tee -a "$LOGFILE"

          if [ "$EXPECTED_HASH" != "$ACTUAL_HASH" ]; then
            echo "âŒ Integrity mismatch detected!" | tee -a "$LOGFILE"
            echo "expected=$EXPECTED_HASH actual=$ACTUAL_HASH" >> "$GITHUB_STEP_SUMMARY"
            exit 1
          fi
          echo "âœ… Integrity verified â€” hashes match." | tee -a "$LOGFILE"

      - name: ðŸ§  Run CAP validation
        run: |
          set -euo pipefail
          echo "ðŸ§  Running CAP validation via local_integrity_check.py"
          python3 scripts/local_integrity_check.py | tee -a archive/CAP_LOGS/integrity_latest.log

      - name: ðŸ§¹ Prune old logs
        run: |
          set -euo pipefail
          echo "ðŸ§¹ Retaining last 10 validation logs..."
          ls -t archive/CAP_LOGS/integrity_*.log | tail -n +11 | xargs -r rm --
          echo "ðŸª¶ Log rotation complete."

      - name: ðŸŒ Optional health probes
        if: success()
        continue-on-error: true
        run: |
          echo "ðŸŒ Checking deployed service health..."
          curl -fsSL https://athena-v3-ikg8.onrender.com/healthz | jq . || echo "âš ï¸ Health probe skipped."
          curl -fsSL https://athena-v3-ikg8.onrender.com/metrics | jq . || true

      - name: âœ… Final report
        if: success()
        run: |
          echo "âœ… Athena Integrity (v7 Final) â€” All validations passed."
          echo "Integrity verified successfully on $(date -u)." >> "$GITHUB_STEP_SUMMARY"

      - name: âŒ Failure report
        if: failure()
        run: |
          echo "âŒ Athena Integrity (v7 Final) â€” Validation failed. Check archive/CAP_LOGS/ for details."
          tail -n 40 archive/CAP_LOGS/integrity_*.log || true
          echo "âŒ Integrity failure logged $(date -u)." >> "$GITHUB_STEP_SUMMARY"
